<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Blue Guardians - Denúncias</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://unpkg.com/lottie-web@5.7.6/build/player/lottie.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/complaints.css">
</head>
<body>
  <!-- Menu -->
  <div class="navbar">
    <button class="menu-toggle" aria-label="Abrir menu">&#9776;</button>
    
    <div class="navbar-links">
      <a href="complaints.html">Denúncias</a>
      <a href="events.html">Eventos</a>
      <a href="politics.html">Política de Privacidade</a>
    </div>
    
    <div class="dropdown-user">
      <i class="fa-solid fa-circle-user"></i>
      <div class="dropdown-content" id="userDropdown">
        <!-- Conteúdo será preenchido dinamicamente via JavaScript -->
      </div>
    </div>
  </div>

    <!-- Conteúdo principal -->
    <main class="container mt-5 pt-5" style="margin-top: 2rem !important;">
   <div class="container-organizacao-eventos-custom d-flex flex-wrap gap-3 justify-content-between align-items-center">
      <!-- Barra de pesquisa -->
      <div class="navbar-pesquisa">
        <div class="d-flex gap-3 align-items-center">
          <input type="text" class="form-control input-pesquisa" placeholder="Buscar denúncias..." aria-label="Buscar eventos" />
          <button class="btn btn-pesquisa" aria-label="Buscar"><i class="fa fa-search"></i></button>
        </div>
      </div>  
        <!-- Botões de ação --> 
        <div class="organizacao-botoes d-flex gap-2">
            <div class="dropdown">
                <button class="ordenar-btn dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-down-up" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M11.5 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L11 2.707V14.5a.5.5 0 0 0 .5.5m-7-14a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L4 13.293V1.5a.5.5 0 0 1 .5-.5"/>
                    </svg>
                    Ordenar por
                </button>
            </div>
            <button type="button" class="bnt-criar-evento" data-bs-toggle="modal" data-bs-target="#staticBackdrop">Faça uma denúncia</button>
        </div>
        </div>
    
        <!-- Modal -->
        <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
            <div class="modal-header" style="background-color: #026395; color: #FFF;">
                <h5 class="modal-title" id="staticBackdropLabel">Nova Denúncia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label for="Input" class="form-label">Título</label>
                    <input type="text" class="form-control" id="inputTitle" placeholder="">
                </div>
                <div class="mb-2">
                    <label for="exampleFormControlTextarea1" class="form-label">Descrição</label>
                    <textarea class="form-control" id="textareaDescricao" rows="3"></textarea>
                </div>
                    <div class="row">
                        <div class="col">
                            <label for="" class="form-label">Data</label>
                            <input id="inputDate" class="form-control" type="date" />
                        </div>
                        <div class="col">
                            <label for="" class="form-label">Horário</label>
                            <input type="time" id="inputTime" class="form-control" name="appt" min="" max="" required />
                        </div>
                    </div>
                    <!--Endereço-->
                    <div class="row">
                        <div class="col-sm-4">
                            <label for="" class="form-label">CEP</label>
                            <input type="text" class="form-control" placeholder="" aria-label="CEP" id="inputCep">
                        </div>
                        <div class="col-sm">
                            <label for="" class="form-label">Cidade</label>
                            <input type="text" class="form-control" placeholder="" aria-label="Cidade">
                        </div>
                        <div class="col-sm">
                            <label for="" class="form-label">Estado</label>
                            <input type="text" class="form-control" placeholder="" aria-label="Estado">
                        </div>
                        <div class="mb-2">
                            <label for="Input" class="form-label">Ponto de Referência</label>
                            <input type="text" class="form-control" id="" placeholder="">
                        </div>
                    </div>
                    <!--Imagem-->
                    <form action="">
                        <label for="img">Imagem:</label>
                        <input type="file" id="img" name="img" accept="image/*">
                        <input type="submit">
                    </form>

                    <!--Categorias-->
                    <div class="categoria">
                        <label for="">Categorias:</label><br>
                        <button type="button" class="btn-categoria">Pesca Ilegal</button>
                        <button type="button" class="btn-categoria">Poluição Sonora</button>
                        <button type="button" class="btn-categoria">Lixo na Praia</button>
                        <button type="button" class="btn-categoria">Animais Mortos</button>
                        <button type="button" class="btn-categoria">Veículos na Praia</button>
                        <button type="button" class="btn-categoria">Outros</button>
                    </div>

                </div>
            <div class="modal-footer">
                <button type="button" class="btn-secundario" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn-primario">Salvar</button>
            </div>
            </div>
        </div>
        </div>

        <!-- Cards Eventos -->
        <section class="cards">
            <div class="card-grid">
                
            </div>
        </section>
    
        <div class="paginacao">
            <button class="ativo">1</button>
            <button>2</button>
            <button>3</button>
            <span>...</span>
            <button>67</button>
            <button>68</button>
        </div>
  </main>

    <!-- Rodapé -->
    <footer class="footer">
        <div class="footer-container">
        <div class="footer-logo">
            <h2>Blue Guardians</h2>
        </div>
        <div class="footer-links">
            <!-- <a href="#home">Meu Perfil</a>
            <a href="#news">Denúncias</a>
            <a href="#news">Política de Privacidade</a> -->
        </div>
        <div class="footer-social">
            <a href="#"><img src="assets/images/facebook.png" alt="Facebook"></a>
            <a href="#"><img src="assets/images/instagram.png" alt="Instagram"></a>
            <a href="#"><img src="assets/images/twitter.png" alt="Twitter"></a>
        </div>
        </div>
        <div class="footer-bottom">
        <p>&copy; 2025 Blue Guardians. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const toggle = document.querySelector('.menu-toggle');
        const links = document.querySelector('.navbar-links');
    
        toggle.addEventListener('click', () => {
        links.classList.toggle('show');
        });

        const searchInput = document.querySelector('.input-pesquisa');
        const searchButton = document.querySelector('.btn-pesquisa');
        const orderButton = document.querySelector('.ordenar-btn');
        const cardGrid = document.querySelector('.card-grid');

        let cards = Array.from(cardGrid.children);

        function filtrarCards() {
        const termo = searchInput.value.toLowerCase();

        cards.forEach(card => {
            const titulo = card.querySelector('h3').textContent.toLowerCase();
            const descricao = card.querySelector('p').textContent.toLowerCase();
            const mostrar = titulo.includes(termo) || descricao.includes(termo);
            card.style.display = mostrar ? '' : 'none';
        });
        }

        function ordenarCards(criterio = 'titulo') {
        // critério pode ser 'titulo' ou 'data' (se tiver)
        cards.sort((a, b) => {
            let aValor, bValor;
            if (criterio === 'titulo') {
            aValor = a.querySelector('h3').textContent.toLowerCase();
            bValor = b.querySelector('h3').textContent.toLowerCase();
            return aValor.localeCompare(bValor);
            }
            // Caso tenha data, implementar aqui
            return 0;
        });

        // Remonta o grid com os cards ordenados
        cards.forEach(card => cardGrid.appendChild(card));
        }

        // Ativa pesquisa ao digitar ou clicar no botão
        searchInput.addEventListener('input', filtrarCards);
        searchButton.addEventListener('click', filtrarCards);

        // Exemplo para ordenar quando clicar no botão de ordenar
        orderButton.addEventListener('click', () => {
        ordenarCards('titulo'); // pode modificar para 'data' depois
        filtrarCards(); // reaplica filtro após ordenar
        });

        const itensPorPagina = 4; // ex: 4 cards por página
        const paginacaoDiv = document.querySelector('.paginacao');
        let paginaAtual = 1;

        function mostrarPagina(pagina) {
        paginaAtual = pagina;
        const inicio = (pagina - 1) * itensPorPagina;
        const fim = inicio + itensPorPagina;

        cards.forEach((card, index) => {
            card.style.display = (index >= inicio && index < fim) ? '' : 'none';
        });

        atualizarPaginacao();
        }

        function atualizarPaginacao() {
        paginacaoDiv.innerHTML = '';

        const totalPaginas = Math.ceil(cards.length / itensPorPagina);

        for(let i = 1; i <= totalPaginas; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            if(i === paginaAtual) btn.classList.add('ativo');
            btn.addEventListener('click', () => mostrarPagina(i));
            paginacaoDiv.appendChild(btn);
        }
        }

        // Inicializa
        mostrarPagina(1);


        // CEP
        const inputCep = document.getElementById('inputCep');
        const inputCidade = document.querySelector('input[aria-label="Cidade"]');
        const inputEstado = document.querySelector('input[aria-label="Estado"]');
        const inputPontoRef = document.getElementById('inputPontoReferencia'); // se quiser preencher

        inputCep.addEventListener('blur', () => {
        const cep = inputCep.value.replace(/\D/g, '');
        if (cep.length !== 8) {
            alert('CEP inválido!');
            return;
        }

        fetch(`https://viacep.com.br/ws/${cep}/json/`)
            .then(res => res.json())
            .then(data => {
            if (data.erro) {
                alert('CEP não encontrado');
                return;
            }
            inputCidade.value = data.localidade;
            inputEstado.value = data.uf;
            // Se quiser preencher mais campos: data.logradouro, data.bairro
            })
            .catch(() => {
            alert('Erro ao consultar CEP');
            });
        });

        // Inclusão das denuncias
        document.addEventListener('DOMContentLoaded', function() {
            const saveButton = document.querySelector('.btn-primario'); // Botão "Salvar"
            
            saveButton.addEventListener('click', async function() {
                const titulo = document.getElementById('inputTitle').value;
                const descricao = document.getElementById('textareaDescricao').value;
                const data = document.getElementById('inputDate').value;
                const hora = document.getElementById('inputTime').value;

                // Exemplo: categoria selecionada
                let categoria = '';
                const categorias = document.querySelectorAll('.btn-categoria');
                categorias.forEach(btn => {
                if (btn.classList.contains('selected')) {
                    categoria = btn.textContent;
                }
                });

                if (!titulo || !descricao) {
                alert('Por favor, preencha título e descrição!');
                return;
                }

                const novaDenuncia = {
                titulo: titulo,
                descricao: descricao,
                data: data,
                hora: hora,
                categoria: categoria,
                imagem: "assets/images/complains_header.jpg" // Por enquanto, imagem estática
                };

                try {
                await fetch('http://localhost:3001/complaints', {
                    method: 'POST',
                    headers: {
                    'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(novaDenuncia)
                });

                // Fecha o modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('staticBackdrop'));
                modal.hide();

                // Limpa os campos
                document.getElementById('inputTitle').value = '';
                document.getElementById('textareaDescricao').value = '';
                document.getElementById('inputDate').value = '';
                document.getElementById('inputTime').value = '';
                categorias.forEach(btn => btn.classList.remove('selected'));

                // Recarrega a lista de denúncias
                carregarDenuncias();

                } catch (error) {
                console.error('Erro ao salvar denúncia:', error);
                alert('Erro ao salvar denúncia!');
                }
            });

            // Função para carregar as denúncias da API
            async function carregarDenuncias() {
                const grid = document.querySelector('.card-grid');
                grid.innerHTML = ''; // Limpa os cards atuais

                try {
                    const response = await fetch('http://localhost:3001/complaints');
                    const denuncias = await response.json();

                    denuncias.forEach(denuncia => {
                        const card = document.createElement('div');
                        card.classList.add('card');
                        card.innerHTML = `
                            <img src="${denuncia.imagem}" alt="Imagem denúncia">
                            <div class="card-content">
                                <h3>${denuncia.titulo}</h3>
                                <p>${denuncia.descricao}</p>
                            </div>
                        `;
                        grid.appendChild(card);
                    });

                    // 🔴 ATUALIZA AQUI:
                    cards = Array.from(cardGrid.children);
                    mostrarPagina(1); // Reseta para página 1 ao recarregar

                } catch (error) {
                    console.error('Erro ao carregar denúncias:', error);
                }
            }

            carregarDenuncias(); // Carregar na primeira vez

            // Seleção de categoria (estilo de toggle)
            const categoriasBotoes = document.querySelectorAll('.btn-categoria');
            categoriasBotoes.forEach(btn => {
                btn.addEventListener('click', function() {
                categoriasBotoes.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                });
            });
            });

        // Status do login
        function checkLoginStatus() {
            const userDropdown = document.getElementById('userDropdown');
            const userItem = localStorage.getItem("usuarioLogado");
            
            let usuarioLogado = null;
            
            if (userItem && userItem !== "undefined") {
                try {
                usuarioLogado = JSON.parse(userItem);
                } catch (e) {
                console.error("Erro ao analisar JSON:", e);
                }
            }

            if (usuarioLogado) {
                userDropdown.innerHTML = `
                <a href="profile.html">Meu Perfil</a>
                <a href="#" id="logoutBtn">Sair</a>
                `;
            } else {
                userDropdown.innerHTML = `
                <a href="profile.html">Meu Perfil</a>
                <a href="login.html">Entrar</a>
                <a href="register.html">Cadastrar-se</a>
                `;
            }
            }
            function handleLogout() {
                localStorage.removeItem('usuarioLogado');
                window.location.href = 'index.html';
            }

            document.addEventListener('DOMContentLoaded', () => {
            checkLoginStatus();
            
            document.addEventListener('click', (e) => {
            if (e.target.id === 'logoutBtn') {
                e.preventDefault();
                handleLogout();
            }
            });
            });
    </script>
</body>
</html>